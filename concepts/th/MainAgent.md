# MainAgent

## คำจำกัดความ

MainAgent คือสายการร้องขอหลักของ Claude Code เมื่อไม่ได้อยู่ในโหมด agent team ทุกครั้งที่ผู้ใช้โต้ตอบกับ Claude Code จะเกิดชุดคำร้องขอ API ขึ้น โดยคำร้องขอ MainAgent จะเป็นสายการสนทนาหลัก — ซึ่งจะมี system prompt ที่สมบูรณ์ คำจำกัดความเครื่องมือ และประวัติข้อความ

## วิธีการระบุ

ใน cc-viewer, MainAgent จะถูกระบุด้วย `req.mainAgent === true` ซึ่งถูกทำเครื่องหมายโดยอัตโนมัติโดย `interceptor.js` ในขณะจับคำร้องขอ

เงื่อนไขการระบุ (ต้องตรงทั้งหมด):
- เนื้อหาคำร้องขอมีฟิลด์ `system` (system prompt)
- เนื้อหาคำร้องขอมีอาร์เรย์ `tools` (คำจำกัดความเครื่องมือ)
- system prompt มีข้อความลักษณะเฉพาะของ "Claude Code"

## ความแตกต่างจาก SubAgent

| ลักษณะ | MainAgent | SubAgent |
|------|-----------|----------|
| system prompt | prompt หลักที่สมบูรณ์ของ Claude Code | prompt แบบย่อเฉพาะงาน |
| อาร์เรย์ tools | มีเครื่องมือทั้งหมดที่ใช้ได้ | โดยปกติมีเฉพาะเครื่องมือที่จำเป็นสำหรับงานเท่านั้น |
| ประวัติข้อความ | สะสมบริบทการสนทนาทั้งหมด | มีเฉพาะข้อความที่เกี่ยวข้องกับงานย่อย |
| พฤติกรรมแคช | มี prompt caching (TTL 5 นาที) | โดยปกติไม่มีแคชหรือแคชขนาดเล็ก |

## ความสำคัญใน cc-viewer

- **การติดตามแคช**: สถานะ prompt caching ของคำร้องขอ MainAgent ส่งผลโดยตรงต่อค่าใช้จ่าย โดยการตรวจสอบสัดส่วนระหว่าง `cache_creation_input_tokens` กับ `cache_read_input_tokens` สามารถประเมินอัตราการเข้าถึงแคชได้
- **การวิเคราะห์การสูญเสียแคช**: เมื่อคำร้องขอ MainAgent มี cache creation จำนวนมาก (แทนที่จะเป็น cache read) แสดงว่าแคชสูญหายและถูกสร้างใหม่ cc-viewer จะทำเครื่องหมายคำร้องขอเหล่านี้ด้วยตัวบ่งชี้จุดสีแดง
- **การวิเคราะห์สายหลัก**: ลำดับคำร้องขอ MainAgent สะท้อนกระบวนการโต้ตอบทั้งหมดของผู้ใช้กับ Claude Code ซึ่งเป็นข้อมูลหลักสำหรับการวิเคราะห์พฤติกรรมเซสชัน
- **การสร้างเซสชันใหม่**: cc-viewer สร้างมุมมองการสนทนา (Chat Mode) ใหม่ผ่านประวัติข้อความของคำร้องขอ MainAgent
