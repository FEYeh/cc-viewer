# MainAgent

## Определение

MainAgent — это основная цепочка запросов Claude Code в режиме без agent team. Каждое взаимодействие пользователя с Claude Code порождает серию API-запросов, из которых запросы MainAgent формируют основную цепочку диалога — они содержат полный system prompt, определения инструментов и историю сообщений.

## Способ идентификации

В cc-viewer MainAgent идентифицируется через `req.mainAgent === true`, автоматически помечается `interceptor.js` при перехвате запроса.

Условия определения (должны выполняться все):
- Тело запроса содержит поле `system` (system prompt)
- Тело запроса содержит массив `tools` (определения инструментов)
- System prompt содержит характерный текст "Claude Code"

## Отличия от SubAgent

| Характеристика | MainAgent | SubAgent |
|------|-----------|----------|
| system prompt | Полный основной prompt Claude Code | Упрощённый prompt, специализированный для задачи |
| массив tools | Содержит все доступные инструменты | Обычно содержит только несколько инструментов, необходимых для задачи |
| история сообщений | Накапливает полный контекст диалога | Содержит только сообщения, связанные с подзадачей |
| поведение кеша | Prompt caching (5 минут TTL) | Обычно без кеша или с небольшим кешем |

## Значение в cc-viewer

- **Отслеживание кеша**: состояние prompt caching запросов MainAgent напрямую влияет на затраты. Мониторинг соотношения `cache_creation_input_tokens` и `cache_read_input_tokens` позволяет оценить коэффициент попаданий в кеш
- **Анализ потери кеша**: когда запрос MainAgent показывает большое количество cache creation (вместо cache read), это означает потерю и пересборку кеша — cc-viewer отмечает такие запросы красным точечным индикатором
- **Анализ основной цепочки**: последовательность запросов MainAgent отражает полный процесс взаимодействия пользователя с Claude Code и является ключевыми данными для анализа поведения сессии
- **Реконструкция сессии**: cc-viewer реконструирует представление диалога (Chat Mode) на основе истории сообщений из запросов MainAgent
