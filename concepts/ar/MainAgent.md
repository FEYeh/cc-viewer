# MainAgent

## التعريف

MainAgent هو سلسلة الطلبات الرئيسية في Claude Code عندما لا يكون في وضع agent team. كل تفاعل بين المستخدم وClaude Code ينتج سلسلة من طلبات API، حيث تشكل طلبات MainAgent سلسلة المحادثة الأساسية — فهي تحمل system prompt الكامل وتعريفات الأدوات وسجل الرسائل.

## طريقة التعرف

في cc-viewer، يُعرَّف MainAgent من خلال `req.mainAgent === true`، ويتم تعيينه تلقائياً بواسطة `interceptor.js` عند التقاط الطلب.

شروط التحديد (يجب استيفاؤها جميعاً):
- جسم الطلب يحتوي على حقل `system` (system prompt)
- جسم الطلب يحتوي على مصفوفة `tools` (تعريفات الأدوات)
- يحتوي system prompt على نص مميز لـ "Claude Code"

## الفرق عن SubAgent

| الخاصية | MainAgent | SubAgent |
|---------|-----------|----------|
| system prompt | prompt رئيسي كامل لـ Claude Code | prompt مختصر مخصص للمهمة |
| مصفوفة tools | تحتوي على جميع الأدوات المتاحة | عادة تحتوي فقط على الأدوات اللازمة للمهمة |
| سجل الرسائل | يتراكم سياق المحادثة الكامل | يحتوي فقط على رسائل المهمة الفرعية |
| سلوك التخزين المؤقت | يوجد prompt caching (TTL 5 دقائق) | عادة بدون تخزين مؤقت أو تخزين مؤقت صغير |

## الأهمية في cc-viewer

- **تتبع الذاكرة المؤقتة**: حالة prompt caching لطلبات MainAgent تؤثر مباشرة على التكاليف. من خلال مراقبة نسبة `cache_creation_input_tokens` إلى `cache_read_input_tokens` يمكن تحديد معدل إصابة الذاكرة المؤقتة
- **تحليل فقدان الذاكرة المؤقتة**: عندما تظهر كمية كبيرة من cache creation (بدلاً من cache read) في طلبات MainAgent، فهذا يعني فقدان الذاكرة المؤقتة وإعادة بنائها، ويقوم cc-viewer بتمييز هذه الطلبات بمؤشر نقطة حمراء
- **تحليل السلسلة الرئيسية**: تعكس تسلسل طلبات MainAgent عملية التفاعل الكاملة بين المستخدم وClaude Code، وهي البيانات الأساسية لتحليل سلوك الجلسة
- **إعادة بناء الجلسة**: يعيد cc-viewer بناء عرض المحادثة (Chat Mode) من خلال سجل رسائل طلبات MainAgent
